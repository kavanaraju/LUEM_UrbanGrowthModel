---
# CPLN 6750 – Phoenix Urban Growth Forecast, 2031

**Authors:** Sravya Dandamudi & Kavana Raju
**Date:** ** 5/10/2025

---

```{r setup, include=FALSE}
# -----------------------------------
# 0. SETUP
# -----------------------------------
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 5
)
# Load packages
pkgs <- c(
  "tidyverse","sf","raster","terra","exactextractr",
  "tidycensus","tigris","FNN","caret","yardstick","plotROC",
  "kableExtra","mapview","FedData"
)
lapply(pkgs, function(p) if(!requireNamespace(p,quietly=TRUE)) install.packages(p))
lapply(pkgs, library, character.only=TRUE)

# Custom helper functions (from example)
quintileBreaks <- function(df, variable) {
  as.character(quantile(df[[variable]], c(.01,.2,.4,.6,.8), na.rm=TRUE))
}
xyC <- function(aPolygonSF) {
  as.data.frame(cbind(
    x=st_coordinates(st_centroid(aPolygonSF))[,1],
    y=st_coordinates(st_centroid(aPolygonSF))[,2]
  ))
}
rast <- function(inRaster) {
  df <- data.frame(xyFromCell(inRaster, 1:ncell(inRaster)),
                   value=getValues(inRaster))
  colnames(df) <- c('x','y','value')
  df
}
nn_function <- function(measureFrom, measureTo, k) {
  mf <- as.matrix(measureFrom)
  mt <- as.matrix(measureTo)
  dists <- get.knnx(mt, mf, k)$nn.dist
  rowMeans(dists)
}
aggregateRaster <- function(rasterList, fishnet) {
  result <- fishnet %>% select()
  for(r in rasterList) {
    nm <- names(r)
    pts <- rasterToPoints(r) %>% as.data.frame() %>%
      st_as_sf(coords=c('x','y'), crs=st_crs(fishnet)) %>%
      filter(get(nm)==1)
    agg <- aggregate(pts, fishnet, length) %>%
      mutate(!!nm := ifelse(is.na(layer), 0, 1)) %>% select(-layer)
    result <- cbind(result, agg)
  }
  result
}
```

# 1. Introduction

This report builds a spatial logistic regression model of urban development in the Phoenix–Mesa–Scottsdale MSA, using land cover change from 2011 to 2021 as training data. We then forecast development to 2031 under a scenario where a new transportation corridor is introduced. Finally, we assess where sensitive lands (flood zones, protected areas) are at risk and propose planning recommendations.

# 2. Workflow Overview

1. Import and preprocess land cover rasters (2011, 2021)  
2. Reclassify to developed/undeveloped and derive change raster  
3. Build a fishnet grid and aggregate raster and vector features to each cell  
4. Engineer predictors: distance to roads, spatial lag, census variables, slope  
5. Train logistic regression model (2011→2021) and validate  
6. Forecast to 2031 using 2021 inputs + new infrastructure scenario  
7. Assess impacts on sensitive lands  
8. Provide three key recommendations

# 3. Study Area Boundary

```{r load-boundary}
# Load Boundary for Phoem
phx_msa <- st_read("data/boundaries/phoenix_msa.geojson", quiet=TRUE) %>%
  st_transform(26912)  # NAD83 / Arizona Central
```

# 4. Load Land Cover Data (NLCD)

```{r load-nlcd}
# Fetch NLCD via FedData
lc_2011 <- get_nlcd(template=phx_msa, label="lc_2011", year=2011) %>% raster()
lc_2021 <- get_nlcd(template=phx_msa, label="lc_2021", year=2021) %>% raster()
```

# 5. Detecting Land Cover Conversion

```{r detect-change}
# Resample to 300m (factor=10)
lc1_rs <- aggregate(lc_2011, fact=10, fun="modal")
lc2_rs <- aggregate(lc_2021, fact=10, fun="modal")

# Reclassify to binary developed
rc <- matrix(c(0,12,0, 12,24,1, 24,Inf,0), ncol=3, byrow=TRUE)
dev1 <- reclassify(lc1_rs, rc)
dev2 <- reclassify(lc2_rs, rc)

# Map algebra: 1 = change from undeveloped to developed
dev_change <- dev1 + dev2
dev_change[dev_change != 1] <- NA
```

# 6. Creating the Fishnet Grid

```{r fishnet}
grid_res <- res(lc1_rs)[1]
fishnet <- st_make_grid(phx_msa, cellsize=grid_res, square=TRUE) %>%
  st_sf() %>% st_intersection(phx_msa) %>%
  mutate(cell_id = row_number())
```

# 7. Join Raster Change to Fishnet

```{r join-change}
pts_change <- rasterToPoints(dev_change) %>% as.data.frame() %>%
  st_as_sf(coords=c('x','y'), crs=st_crs(fishnet))
fishnet <- aggregate(pts_change, fishnet, FUN=sum) %>%
  mutate(development_change = factor(ifelse(layer>0,1,0))) %>%
  select(-layer)
```

# 8. Aggregating Land Cover Categories

```{r lc-categories}
# Reclassify full NLCD into categories
lc1_rs %>% names() # check
# Example: Developed, Forest, Farm, Wetlands, Other, Water
dev_2011 <- lc1_rs %in% c(21:24);
forest_2011 <- lc1_rs %in% c(41:43);
farm_2011 <- lc1_rs %in% c(81:82);
wet_2011 <- lc1_rs %in% c(90,95);
oth_2011 <- lc1_rs %in% c(52,71,31);
water_2011 <- lc1_rs == 11

# Name and aggregate
names_list1 <- c("dev1","forest1","farm1","wet1","oth1","water1")
rasters1 <- setNames(list(dev_2011, forest_2011, farm_2011, wet_2011, oth_2011, water_2011), names_list1)
fishnet_lc1 <- aggregateRaster(rasters1, fishnet)

# Repeat for 2021
dev_2021 <- lc2_rs %in% c(21:24);
forest_2021 <- lc2_rs %in% c(41:43);
farm_2021 <- lc2_rs %in% c(81:82);
wet_2021 <- lc2_rs %in% c(90,95);
oth_2021 <- lc2_rs %in% c(52,71,31);
water_2021 <- lc2_rs == 11
rasters2 <- setNames(list(dev_2021, forest_2021, farm_2021, wet_2021, oth_2021, water_2021),
                     c("dev2","forest2","farm2","wet2","oth2","water2"))
fishnet_lc2 <- aggregateRaster(rasters2, fishnet)
```

# 9. Population & Socioeconomic Data via tidycensus

```{r census}
# Enter your key
census_api_key("<YOUR_KEY>", install=FALSE)

# Variables
vars <- c(pop="B01003_001E", income="B19013_001E", housing="B25001_001E")

# Download 2011 and 2021 at tract level, for Maricopa & Pinal
counties <- c("Maricopa","Pinal")
acs11 <- get_acs("tract", vars, year=2011, state="AZ", county=counties,
                 geometry=TRUE, output="wide") %>% st_transform(st_crs(fishnet))
acs21 <- get_acs("tract", vars, year=2021, state="AZ", county=counties,
                 geometry=TRUE, output="wide") %>% st_transform(st_crs(fishnet))

# Areal weighted interpolation
fishnet_pop11 <- st_interpolate_aw(acs11[c("popE","incomeE","housingE")], fishnet)
names(fishnet_pop11) <- c("pop11","inc11","house11")
fishnet_pop21 <- st_interpolate_aw(acs21[c("popE","incomeE","housingE")], fishnet)
names(fishnet_pop21) <- c("pop21","inc21","house21")
```

# 10. Transportation & Infrastructure Features

```{r transport}
# Highways
hwys <- primary_secondary_roads(state="AZ") %>% st_transform(st_crs(fishnet)) %>%
  st_union()
# Distance to highways at t1 and t2 (assumed same)
centroids <- st_centroid(fishnet)
fishnet$dist_hwy <- as.numeric(st_distance(centroids, hwys))

# Hypothetical new corridor: digitize or load
# new_corr <- mapedit::editMap(mapview(centroids))$finished
new_corr <- st_read("data/infra/proposed_corridor_2031.shp") %>% st_transform(st_crs(fishnet))
fishnet$dist_new <- as.numeric(st_distance(centroids, new_corr))
```

# 11. Spatial Lag of Development

```{r spatial-lag}
# Coordinates for knn
grid_xy <- st_coordinates(centroids)
dev_points1 <- fishnet_lc1 %>% filter(dev1==1) %>% st_centroid() %>% st_coordinates()
fishnet$lagDev1 <- nn_function(grid_xy, dev_points1, k=2)

# Repeat for t2
dev_points2 <- fishnet_lc2 %>% filter(dev2==1) %>% st_centroid() %>% st_coordinates()
fishnet$lagDev2 <- nn_function(grid_xy, dev_points2, k=2)
```

# 12. County Fixed Effects

```{r county-fe}
cts <- counties(state="AZ", cb=TRUE) %>% st_transform(st_crs(fishnet)) %>%
  filter(NAME %in% c("Maricopa","Pinal"))
fishnet <- fishnet %>% st_join(cts["NAME"]) %>% rename(county=NAME)
```

# 13. Compile Modeling Data Sets

```{r compile}
# t1 data
dat11 <- bind_cols(
  st_drop_geometry(fishnet),
  st_drop_geometry(fishnet_lc1),
  st_drop_geometry(select(fishnet, dist_hwy, dist_new, lagDev1)),
  st_drop_geometry(fishnet_pop11)
) %>%
  select(cell_id, development_change, everything()) %>%
  filter(water1==0)
# rename t1 vars by dropping suffixes

# t2 data (forecast)
dat21 <- bind_cols(
  st_drop_geometry(fishnet),
  st_drop_geometry(fishnet_lc2),
  st_drop_geometry(select(fishnet, dist_hwy, dist_new, lagDev2)),
  st_drop_geometry(fishnet_pop21)
) %>% filter(water2==0)
```

# 14. Model Training & Validation

```{r modeling}
set.seed(1234)
idx <- createDataPartition(dat11$development_change, p=.7, list=FALSE)
train <- dat11[idx,]; test <- dat11[-idx,]
# Fit logit\model <- glm(development_change~dist_hwy+dist_new+pop11+lagDev1+inc11+housing11+county,
             data=train, family=binomial)
summary(model)
# ROC
probs <- predict(model, test, type="response")
ggplot(data.frame(obs=test$development_change, pred=probs),
       aes(d=as.numeric(obs), m=pred)) + geom_roc() + theme_minimal()
auc(roc(test$development_change, probs))
# Confusion
thr <- 0.1
pred_class <- factor(ifelse(probs>thr,1,0))
confusionMatrix(pred_class, factor(test$development_change), positive="1")
```

# 15. Forecast to 2031 & Impact Assessment

```{r forecast}
# Predict
dat21$prob31 <- predict(model, dat21, type="response")
dat21$pred31 <- factor(ifelse(dat21$prob31>thr,1,0))
forecast_sf <- left_join(fishnet, dat21, by="cell_id")
# Sensitive overlays
flood <- st_read("data/flood/fema_flood.shp") %>% st_transform(st_crs(fishnet))
prot  <- st_read("data/padus/padus_az.shp") %>% st_transform(st_crs(fishnet))
forecast_sf$flood_risk <- lengths(st_intersects(forecast_sf, flood))>0
forecast_sf$prot_risk  <- lengths(st_intersects(forecast_sf, prot))>0
# Summary
risk_sum <- forecast_sf %>%
  filter(pred31==1) %>%
  summarize(
    pct_flood=sum(flood_risk)/n()*100,
    pct_prot=sum(prot_risk)/n()*100
  )
kable(risk_sum)
# Map
ggplot(forecast_sf) +
  geom_sf(aes(fill=pred31), color=NA) +
  geom_sf(data=phx_msa, fill=NA) +
  labs(title="Projected 2031 Development") +
  theme_void()
```

# Recommendations

1. Strengthen floodplain regulations where > `r round(risk_sum$pct_flood,1)`% expansion occurs in flood zones.  
2. Establish green buffers around protected lands given ~`r round(risk_sum$pct_prot,1)`% overlap.  
3. Incentivize infill and higher density within 0.5 mi of the new corridor to curb leapfrog sprawl.

---

<small>Adapted from Houston Urban Growth Modeling example (Fichman et al.).</small>
